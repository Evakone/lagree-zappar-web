<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LCS+E AR â€“ Zappar</title>
    <link rel="stylesheet" href="./brand.css">
    <style>
      :root {
        color-scheme: dark;
        --overlay-bg: rgba(11, 15, 17, 0.86);
        --accent: #66e5ff;
      }

      body,
      html {
        margin: 0;
        height: 100%;
        overflow: hidden;
        font-family: 'Zen Kaku Gothic New', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background: #050607;
        color: #f5f7fa;
      }

      canvas#zappar-canvas {
        width: 100vw;
        height: 100vh;
        display: block;
        background: #000;
      }

      .ui-overlay {
        position: fixed;
        inset: 0;
        display: grid;
        place-items: center;
        padding: 32px;
        backdrop-filter: blur(6px);
        background: var(--overlay-bg);
        z-index: 3;
        transition: opacity 200ms ease;
      }

      .ui-overlay.hidden {
        opacity: 0;
        pointer-events: none;
      }

      .ui-panel {
        max-width: min(360px, 90vw);
        background: rgba(12, 16, 20, 0.9);
        border-radius: 18px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        padding: 24px 28px;
        text-align: center;
        box-shadow: 0 18px 48px rgba(0, 0, 0, 0.55);
      }

      .ui-panel h1 {
        margin: 0 0 12px;
        font-size: 1.28rem;
        letter-spacing: -0.01em;
      }

      .ui-panel p {
        margin: 0 0 20px;
        color: rgba(235, 242, 248, 0.82);
        line-height: 1.5;
      }

      .ui-panel button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        font-weight: 600;
        padding: 14px 24px;
        width: 100%;
        border-radius: 14px;
        border: none;
        background: linear-gradient(120deg, var(--accent), #32aaff);
        color: #05171c;
        font-size: 1rem;
        cursor: pointer;
        box-shadow: 0 10px 32px rgba(30, 126, 195, 0.35);
        transition: transform 160ms ease, box-shadow 160ms ease;
      }

      .ui-panel button:hover,
      .ui-panel button:focus-visible {
        transform: translateY(-2px);
        box-shadow: 0 16px 40px rgba(30, 126, 195, 0.45);
      }

      .status-chip {
        position: fixed;
        left: 50%;
        bottom: 24px;
        transform: translateX(-50%);
        background: rgba(9, 13, 16, 0.8);
        border: 1px solid rgba(102, 229, 255, 0.35);
        color: rgba(207, 244, 255, 0.85);
        border-radius: 999px;
        padding: 10px 18px;
        font-size: 0.95rem;
        letter-spacing: 0.02em;
        display: flex;
        align-items: center;
        gap: 10px;
        z-index: 2;
        transition: opacity 200ms ease;
      }

      .status-chip.hidden {
        opacity: 0;
      }

      .status-chip span {
        display: inline-flex;
        width: 12px;
        height: 12px;
        border-radius: 999px;
        background: var(--accent);
        box-shadow: 0 0 0 6px rgba(102, 229, 255, 0.16);
      }

      @media (orientation: landscape) and (max-height: 460px) {
        .ui-panel {
          padding: 20px 22px;
        }
        .ui-panel h1 {
          font-size: 1.1rem;
        }
        .ui-panel p {
          font-size: 0.9rem;
        }
      }
    </style>
  </head>
  <body>
    <canvas id="zappar-canvas"></canvas>

    <div class="ui-overlay" id="permission-overlay" role="dialog" aria-live="polite">
      <div class="ui-panel">
        <h1>Activate Camera</h1>
        <p>We use Zappar's camera pipeline for tracking. Grant access, then point at the marker to launch the AR content.</p>
        <button type="button" id="permission-button">ðŸ”“ Start Experience</button>
      </div>
    </div>

    <div class="status-chip" id="tracking-status" aria-live="polite">
      <span aria-hidden="true"></span>
      Looking for markerâ€¦
    </div>

    <script type="importmap">
      {
        "imports": {
          "three": "https://cdn.jsdelivr.net/npm/three@0.155.0/build/three.module.js",
          "three/examples/jsm/loaders/GLTFLoader.js": "https://cdn.jsdelivr.net/npm/three@0.155.0/examples/jsm/loaders/GLTFLoader.js"
        }
      }
    </script>

    <script type="module">
      import * as THREE from 'three';
      import { GLTFLoader } from 'three/examples/jsm/loaders/GLTFLoader.js';

      window.THREE = THREE;

      await new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = 'https://libs.zappar.com/zappar-threejs/2.5.2/zappar-threejs.js';
        script.async = true;
        script.onload = () => resolve();
        script.onerror = () => reject(new Error('Failed to load ZapparThree library'));
        document.head.appendChild(script);
      });

      const ZapparThree = window.ZapparThree;
      if (!ZapparThree) {
        console.error('[zappar] ZapparThree failed to load');
        throw new Error('ZapparThree unavailable');
      }
      if (ZapparThree.VERSION) {
        console.info(`[zappar] ZapparThree ${ZapparThree.VERSION}`);
      }

      // If you're hosting on Zappar's domains, no license key is required.

      const canvas = document.getElementById('zappar-canvas');
      const overlay = document.getElementById('permission-overlay');
      const permissionButton = document.getElementById('permission-button');
      const trackingStatus = document.getElementById('tracking-status');

      const state = {
        renderer: null,
        camera: null,
        anchorGroup: null,
        sceneReady: false,
      };

      async function initialiseScene() {
        if (state.sceneReady) return;

        const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);

        ZapparThree.glContextSet(renderer.getContext());

        const scene = new THREE.Scene();
        scene.background = null;

        const camera = new ZapparThree.Camera();
        scene.add(camera);

        let tracker;
        try {
          const trackerLoader = new ZapparThree.ImageTrackerLoader();
          tracker = await trackerLoader.load('./assets/marker.zpt');
          console.info('[zappar] tracker ready');
        } catch (error) {
          console.error('[zappar] failed to load marker.zpt', error);
          overlay.querySelector('p').textContent = 'Unable to load tracking data. Check the console and try again.';
          permissionButton.disabled = true;
          throw error;
        }

        const anchorGroup = new ZapparThree.ImageAnchorGroup(camera, tracker);
        scene.add(anchorGroup);

        const ambientLight = new THREE.AmbientLight(0xffffff, 1.1);
        anchorGroup.add(ambientLight);
        const directional = new THREE.DirectionalLight(0xffffff, 0.6);
        directional.position.set(1, 1, 1);
        anchorGroup.add(directional);

        const gltfLoader = new GLTFLoader();
        gltfLoader.load(
          './assets/lagree-sign.glb',
          (gltf) => {
            const content = gltf.scene;
            content.scale.setScalar(0.25);
            content.position.set(0, 0, 0);
            content.rotation.set(-Math.PI / 2, 0, 0);
            anchorGroup.add(content);
          },
          undefined,
          (error) => {
            console.error('[zappar] failed to load lagree-sign.glb', error);
          }
        );

        tracker.onNewAnchor.bind((anchor) => {
          console.info('[zappar] new anchor', anchor.id);
        });

        tracker.onVisible.bind((anchor) => {
          console.info('[zappar] anchor visible', anchor.id);
          trackingStatus.classList.add('hidden');
        });

        tracker.onNotVisible.bind((anchor) => {
          console.info('[zappar] anchor lost', anchor.id);
          trackingStatus.classList.remove('hidden');
        });

        function resizeRenderer() {
          renderer.setSize(window.innerWidth, window.innerHeight);
        }

        window.addEventListener('resize', resizeRenderer);

        const render = () => {
          camera.updateFrame(renderer);
          renderer.render(scene, camera);
        };

        renderer.setAnimationLoop(render);

        state.renderer = renderer;
        state.camera = camera;
        state.anchorGroup = anchorGroup;
        state.sceneReady = true;
      }

      async function startExperience() {
        if (!state.sceneReady) {
          try {
            await initialiseScene();
          } catch (error) {
            console.error('[zappar] initialiseScene() rejected', error);
            return;
          }
        }

        let granted = false;
        try {
          granted = await ZapparThree.permissionRequest();
        } catch (error) {
          console.error('[zappar] permission request threw', error);
        }

        if (!granted) {
          ZapparThree.permissionDeniedUI();
          return;
        }

        try {
          await state.camera.start();
          overlay.classList.add('hidden');
          trackingStatus.classList.remove('hidden');
        } catch (error) {
          console.error('[zappar] camera start failed', error);
          overlay.querySelector('p').textContent = 'Camera failed to start. Please refresh and allow camera access.';
        }
      }

      permissionButton.addEventListener('click', () => {
        console.info('[zappar] start button tapped');
        startExperience().catch((err) => {
          console.error('[zappar] startExperience() rejected', err);
        });
      });

      // Warm the scene as soon as scripts load.
      initialiseScene().catch((err) => {
        console.error('[zappar] initialisation failure', err);
      });
    </script>
  </body>
</html>
